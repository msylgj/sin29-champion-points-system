# 积分规则修正总结

**修正时间**：2026-01-29  
**修正类型**：超出排名范围的选手积分规则

## 修正内容

### 修正前（错误规则）
- 超出基础积分表排名范围的选手 → **不获得任何积分（0分）**
- 示例：排名赛第10名，20人参赛（系数0.8，限制前8名）→ 0分

### 修正后（正确规则）
- 超出基础积分表排名范围的选手 → **获得1分的基础积分，仍需乘以系数**
- 示例：排名赛第10名，20人参赛（系数0.8，限制前8名）→ 1 × 0.8 = **0.8分**

## 涉及的规则表

### 1. 排名赛基础积分表
```
排名1-8：25, 22, 19, 15, 10, 8, 6, 4分
排名9+：1分（修正前为0分）
```

### 2. 淘汰赛基础积分表
```
排名1：45分
排名2：40分
排名3：35分
排名4：30分
排名5-8：20分
排名9-16：15分
排名17+：1分（修正前为0分）
```

### 3. 团体赛基础积分表
```
排名1-8：20, 15, 10, 8, 5, 4, 3, 2分/人
排名9+：1分/人（修正前为0分）
```

## 计算流程图（修正后）

```
开始
  ↓
[步骤1] 获取基础积分
  ├─ 排名在积分表内 → 获得对应积分
  └─ 排名超出积分表 → 获得1分
  ↓
[步骤2] 确定参赛人数系数
  └─ 根据人数范围查找系数和限制
  ↓
[步骤3] 检查"原额积分"限制
  ├─ 排名在限制内 → 使用步骤1的积分
  └─ 排名超出限制 → 替换为1分
  ↓
[步骤4] 计算最终积分
  └─ 最终积分 = 基础积分 × 系数
  ↓
[步骤5] 判断是否18米
  ├─ 是18米 → 最终积分 × 0.5
  └─ 不是 → 保持不变
  ↓
结束
```

## 具体例子

### 例1：排名赛超出原额限制
```
排名：第10名
赛制：排名赛（30米）
参赛人数：20人

计算过程：
1. 基础积分：1分（排名10超出表范围8）
2. 系数：0.8（20人在16-31范围）
3. 原额限制检查：第10名 > 8名 → 替换为1分
4. 中间积分：1 × 0.8 = 0.8分
5. 非18米：保持0.8分

最终：0.8分
```

### 例2：排名赛在原额限制内
```
排名：第3名
赛制：排名赛（30米）
参赛人数：20人

计算过程：
1. 基础积分：19分
2. 系数：0.8（20人在16-31范围）
3. 原额限制检查：第3名 ≤ 8名 → 使用19分
4. 中间积分：19 × 0.8 = 15.2分
5. 非18米：保持15.2分

最终：15.2分
```

### 例3：淘汰赛超出所有限制（18米）
```
排名：第30名
赛制：淘汰赛（18米）
参赛人数：60人

计算过程：
1. 基础积分：1分（排名30超出淘汰赛范围）
2. 系数：1.0（60人在32-63范围）
3. 原额限制检查：第30名 > 16名 → 替换为1分
4. 中间积分：1 × 1.0 = 1分
5. 18米减半：1 × 0.5 = 0.5分

最终：0.5分
```

## 代码修正

### 修正位置：backend/app/services/scoring_calculator.py

**calculate_base_points()** 方法：
- 排名赛：超出范围改为返回1.0（修正前返回0.0）
- 淘汰赛：超出16名改为返回1.0（修正前返回0.0）
- 团体赛：超出范围改为返回1.0（修正前返回0.0）

**calculate_points()** 方法：
- 移除了 `if base_points == 0: return 0.0` 的检查
- 修改排名限制检查逻辑：超出限制时替换为1分，而非返回0分

### 修正位置：backend/tests/test_scoring_calculator.py

**新增测试**：
- `test_ranking_points_beyond_limit()`：排名赛超出限制的积分
- `test_elimination_points_beyond_limit()`：淘汰赛超出限制的积分
- `test_team_points_beyond_limit()`：团体赛超出限制的积分

**修改测试**：
- `test_base_points_ranking()`：第9名及以上返回1分
- `test_base_points_elimination()`：第17名及以上返回1分
- `test_base_points_team()`：第9名及以上返回1分

## 积分规则文档更新

**修正位置**：SCORING_RULES.md

- 更新所有基础积分表
- 修正参赛人数系数说明
- 更新计算步骤说明
- 补充"超出限制"的例子

## 验证方式

已通过以下方式验证修正的正确性：

1. **单元测试**：
   - `test_base_points_*()` 系列测试基础积分
   - `test_*_points_beyond_limit()` 系列测试超出限制情况
   - 所有测试用例已更新

2. **手工验证**：
   - 创建 `verify_scoring.py` 脚本演示修正后的计算流程
   - 详细展示5个典型场景的计算过程

3. **规则文档**：
   - SCORING_RULES.md 已更新，包含完整说明和例子

## 规则变更影响

### 对现有数据的影响
- 如果系统中已有超出排名限制的成绩记录（积分为0），需要根据新规则重新计算
- 受影响的成绩数量可能较少（通常只有排名较后的选手）

### 对后续开发的影响
- 所有依赖 ScoringCalculator 的 API 端点会自动使用新规则
- 不需要修改 API 的调用方式

### 对选手积分的影响
- **正向**：原本获得0分的选手现在可以获得至少0.6分（最低系数0.6时）
- **影响程度**：仅限参加比赛但排名超出基础积分表范围的选手
- **典型收益**：
  - 小规模赛事（8-15人）超出4名限制的选手：1 × 0.6 = 0.6分
  - 中等规模赛事（16-31人）超出8名限制的选手：1 × 0.8 = 0.8分
  - 大规模赛事（32+人）超出16名限制的选手：1 × 1.0 = 1分（或1.2/1.4）

---

**修正状态**：✅ 已完成  
**代码位置**：backend/app/services/scoring_calculator.py  
**测试位置**：backend/tests/test_scoring_calculator.py  
**文档位置**：SCORING_RULES.md
